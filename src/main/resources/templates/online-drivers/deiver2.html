<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de bord du chauffeur</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.2/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        .notification {
            background-color: #e7f3fe;
            border-left: 6px solid #2196F3;
            margin-bottom: 15px;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .notification h3 {
            margin-top: 0;
            color: #2196F3;
        }
        .notification p {
            margin: 5px 0;
        }
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #333;
        }
        button {
            margin: 5px;
            padding: 10px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #1976D2;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .btn-decline {
            background-color: #f44336;
        }
        .btn-decline:hover {
            background-color: #d32f2f;
        }
    </style>
    <script>
        const driverId = "68ed08d227e53254b77199c2"; // Driver 1 ID
        const token = "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJsYXJpYmkucmFtaUBlc3ByaXQudG4iLCJyb2xlcyI6WyJST0xFX0RSSVZFUiJdLCJ1c2VySWQiOiI2OGVkMDhkMjI3ZTUzMjU0Yjc3MTk5YzIiLCJmaXJzdE5hbWUiOiJyYW1pIiwibGFzdE5hbWUiOiJyYW1pIiwicGhvbmVOdW1iZXIiOiIrMzM2MTIzNDU2NzgiLCJpYXQiOjE3NjAzNjYwNjEsImV4cCI6MTc2MDQwMjA2MX0.HVS_hpLZY2jfvj_VGgbIOBP11j3-aPwLCzw1GIJgFkQ";

        let currentMoveId = null;

        const socket = new SockJS('http://localhost:8090/ws');
        const stompClient = Stomp.over(socket);

        stompClient.connect({ 'Authorization': 'Bearer ' + token }, function(frame) {
            console.log('‚úÖ Connect√©: ' + frame);
            stompClient.subscribe('/topic/driver/' + driverId, function(message) {
                console.log("üì© Notification re√ßue: ", message.body);
                try {
                    const notification = JSON.parse(message.body);
                    const now = new Date().toLocaleString();
                    const notificationList = document.getElementById('notification-list');

                    if (notification.notificationType === "MISSION_OFFER") {
                        const mission = notification.metadata;
                        let notificationDiv = document.createElement('div');
                        notificationDiv.className = 'notification';
                        notificationDiv.id = `notification-${mission.moveId}`;
                        notificationDiv.innerHTML = `
                            <h3>${notification.title}</h3>
                            <p><strong>Re√ßue √†:</strong> ${now}</p>
                            <p>${notification.body}</p>
                            <p><strong>ID de la mission:</strong> ${mission.moveId}</p>
                            <p><strong>Expire dans:</strong> <span id="countdown-${mission.moveId}">${mission.remainingSeconds}</span> secondes</p>
                            <button onclick="acceptMission('${mission.moveId}')">‚úÖ Accepter la mission</button>
                            <button class="btn-decline" onclick="declineMission('${mission.moveId}')">‚ùå Refuser la mission</button>
                        `;
                        notificationList.innerHTML = '';
                        notificationList.appendChild(notificationDiv);

                        // Gestion du compte √† rebours
                        if (mission.remainingSeconds > 0) {
                            let countdown = parseInt(mission.remainingSeconds, 10);
                            const countdownElement = document.getElementById(`countdown-${mission.moveId}`);
                            const interval = setInterval(() => {
                                countdown--;
                                if (countdown >= 0) {
                                    countdownElement.textContent = countdown;
                                } else {
                                    clearInterval(interval);
                                    countdownElement.textContent = "Expir√©e";
                                    notificationDiv.querySelectorAll('button').forEach(btn => btn.disabled = true);
                                }
                            }, 1000);
                        }
                    }
                } catch (error) {
                    console.error("‚ùå Erreur lors de l'analyse de la notification: ", error);
                }
            });
        }, function(error) {
            console.error("üö® Erreur STOMP: " + error);
            setTimeout(() => {
                stompClient.connect({ 'Authorization': 'Bearer ' + token }, function(frame) {
                    console.log('üîÑ Reconnect√©: ' + frame);
                });
            }, 5000);
        });

        // ‚úÖ Fonction pour accepter la mission
        function acceptMission(moveId) {
            const url = `http://localhost:8090/api/moves/${moveId}/accept`;
            fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (response.ok) {
                        console.log('‚úÖ Mission accept√©e avec succ√®s');
                        currentMoveId = moveId;
                        const acceptButton = document.querySelector(`#notification-${moveId} button`);
                        if (acceptButton) acceptButton.disabled = true;
                    } else {
                        console.error('‚ö†Ô∏è Erreur lors de l\'acceptation de la mission');
                        alert('Erreur lors de l\'acceptation de la mission');
                    }
                })
                .catch(error => {
                    console.error('‚ùå Erreur lors de la requ√™te:', error);
                    alert('Erreur r√©seau lors de l\'acceptation');
                });
        }

        // ‚ùå Fonction pour refuser la mission
        function declineMission(moveId) {
            const url = `http://localhost:8090/api/moves/${moveId}/decline`;
            fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (response.ok) {
                        console.log('üö´ Mission refus√©e avec succ√®s');
                        alert('Mission refus√©e avec succ√®s');
                        document.getElementById(`notification-${moveId}`).remove();
                    } else if (response.status === 400) {
                        alert("‚ö†Ô∏è La mission n'est plus en attente.");
                    } else if (response.status === 403) {
                        alert("‚õî Vous n'√™tes pas le chauffeur assign√© √† cette mission.");
                    } else if (response.status === 404) {
                        alert("‚ùå Mission introuvable.");
                    } else {
                        alert("‚ö†Ô∏è Erreur inconnue lors du refus de la mission.");
                    }
                })
                .catch(error => {
                    console.error('‚ùå Erreur lors du refus de la mission:', error);
                    alert('Erreur r√©seau lors du refus de la mission.');
                });
        }

        // üîÅ Avancer le statut de mission
        function advanceMissionStatus() {
            if (!currentMoveId) {
                console.error('‚ö†Ô∏è Aucune mission accept√©e');
                alert('Veuillez d‚Äôabord accepter une mission.');
                return;
            }
            const statusUpdate = { moveId: currentMoveId, driverId: driverId };
            stompClient.send("/app/mission/status/next", {}, JSON.stringify(statusUpdate));
            console.log("‚û°Ô∏è Demande d'avancement du statut envoy√©e");
        }

        // üìç Mise √† jour automatique de la localisation
        setInterval(() => {
            if (stompClient.connected) {
                const locationUpdate = {
                    driverId: driverId,
                    latitude: 48.868335029786856 + Math.random() * 0.000001,
                    longitude: 2.3655909803206265 + Math.random() * 0.000001
                };
                stompClient.send("/app/driver/location", {}, JSON.stringify(locationUpdate));
                console.log("üì° Localisation envoy√©e: " + JSON.stringify(locationUpdate));
            }
        }, 10000);
    </script>
</head>
<body>
<h1>üöó Tableau de bord du chauffeur</h1>
<p>Ouvrez la console (F12) pour voir les logs et suivre le statut en temps r√©el.</p>
<div id="notifications">
    <h2>üì¨ Notifications</h2>
    <div id="notification-list"></div>
</div>
<div>
    <h2>‚öôÔ∏è Mettre √† jour le statut de la mission</h2>
    <button onclick="advanceMissionStatus()">‚û°Ô∏è Avancer au statut suivant</button>
</div>
</body>
</html>
