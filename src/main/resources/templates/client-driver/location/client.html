<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Client WebSocket Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.2/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        #map { height: 400px; width: 100%; }
    </style>
</head>
<body>
<h1>Track Your Driver</h1>
<div id="status">Connecting...</div>
<div id="map"></div>
<div id="location"></div>

<script>
    // Ensure this moveId matches a mission where the client is "radhwen44@gmail.com"
    const moveId = "6901d94d-b970-416c-915d-857303d4feee";
    const jwtToken = "Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJyYWRod2VuNDRAZ21haWwuY29tIiwicm9sZXMiOlsiUk9MRV9DTElFTlQiXSwidXNlcklkIjoiNjdmZjcyNDBlNGRjYmUyNWMzMzA2MTAwIiwiaWF0IjoxNzQ1MzI5NDg5LCJleHAiOjE3NDUzMzMwODl9.GodWrh9kuOHHoqL_Wia1ohl0ElIBS2dMd5uupXABR9c";

    const socket = new SockJS('http://localhost:8090/ws');
    const stompClient = Stomp.over(socket);

    var map = L.map('map').setView([51.505, -0.09], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    var driverMarker;

    stompClient.connect({'Authorization': jwtToken}, function (frame) {
        document.getElementById('status').innerText = 'Connected';
        console.log('Connected: ' + frame);

        stompClient.subscribe('/topic/mission/' + moveId + '/location', function (message) {
            console.log('Received location update:', message.body);
            const location = JSON.parse(message.body);
            const lat = location.latitude;
            const lon = location.longitude;

            map.setView([lat, lon], 13);
            if (driverMarker) {
                driverMarker.setLatLng([lat, lon]);
            } else {
                driverMarker = L.marker([lat, lon]).addTo(map);
            }
            document.getElementById('location').innerText = `Driver Location: Lat ${lat}, Lon ${lon}`;
        });

        stompClient.subscribe('/topic/mission/' + moveId + '/updates', function (message) {
            console.log('Mission update:', message.body);
        });
    }, function (error) {
        document.getElementById('status').innerText = 'Connection Error: ' + error;
        console.error('Connection error:', error);
    });
</script>
</body>
</html>